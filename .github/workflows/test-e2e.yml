name: Bats E2E Tests
# This workflow runs the Bats E2E tests for aggkit.

on:
  push:
    branches:
      - '**'
  workflow_dispatch: {}

jobs:
  build-aggkit-image:
    uses: ./.github/workflows/build-aggkit-image.yml
    with:
      go-version: 1.24.x
      docker-image-name: aggkit

  single-l2-chain:
    needs: build-aggkit-image
    runs-on: amd-runner-2204
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        e2e-group:
          - fork12-pessimistic
          - fork12-op-succinct

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set kurtosis-cdk ref
        id: set-kurtosis-cdk-ref
        run: |
          if [[ "${{ matrix.e2e-group }}" == "fork12-pessimistic" ]]; then
            # https://github.com/0xPolygon/kurtosis-cdk/tree/feat/aggsender-agglayer-grpc-integration
            echo "ref=a2c9dee54f60063b45727ecfefbe186649987eab" >> $GITHUB_OUTPUT
          elif [[ "${{ matrix.e2e-group }}" == "fork12-op-succinct" ]]; then
            # https://github.com/0xPolygon/kurtosis-cdk/tree/main
            echo "ref=a2c9dee54f60063b45727ecfefbe186649987eab" >> $GITHUB_OUTPUT 
          else
            echo "Unknown e2e group ${{ matrix.e2e-group }}" >&2
            exit 1
          fi

      - name: Checkout kurtosis-cdk
        uses: actions/checkout@v4
        with:
          repository: 0xPolygon/kurtosis-cdk
          path: kurtosis-cdk
          ref: ${{ steps.set-kurtosis-cdk-ref.outputs.ref }}

      - name: Pre kurtosis run
        uses: ./kurtosis-cdk/.github/actions/kurtosis-pre-run

      - name: Setup Bats and bats libs
        uses: bats-core/bats-action@2.0.0

      - name: Download aggkit archive
        uses: actions/download-artifact@v4
        with:
          name: aggkit
          path: /tmp

      - name: Load aggkit image
        run: |
          docker load --input /tmp/aggkit.tar
          docker image ls -a

      - name: Run E2E tests
        run: make test-e2e-${{ matrix.e2e-group }}
        working-directory: test
        env:
          KURTOSIS_FOLDER: ${{ github.workspace }}/kurtosis-cdk
          BATS_LIB_PATH: /usr/lib/
          AGGLAYER_PROVER_SP1_KEY: ${{ secrets.SP1_PRIVATE_KEY }}

      - name: Dump enclave logs
        if: failure()
        run: kurtosis dump ./dump

      - name: Generate archive name
        if: failure()
        run: |
          archive_name="dump_run_with_args_${{matrix.e2e-group}}_${{ github.run_id }}"
          echo "ARCHIVE_NAME=${archive_name}" >> "$GITHUB_ENV"
          echo "Generated archive name: ${archive_name}"

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARCHIVE_NAME }}
          path: ./dump

  multi-l2-chains:
    needs: build-aggkit-image
    runs-on: amd-runner-2204
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.24.x

      - name: Build Tools
        run: make build-tools

      - name: Checkout kurtosis-cdk
        uses: actions/checkout@v4
        with:
          repository: 0xPolygon/kurtosis-cdk
          path: kurtosis-cdk
          ref: a2c9dee54f60063b45727ecfefbe186649987eab

      - name: Pre kurtosis run
        uses: ./kurtosis-cdk/.github/actions/kurtosis-pre-run

      - name: Setup Bats and bats libs
        uses: bats-core/bats-action@2.0.0

      - name: Download aggkit archive
        uses: actions/download-artifact@v4
        with:
          name: aggkit
          path: /tmp

      - name: Load aggkit image
        run: |
          docker load --input /tmp/aggkit.tar
          docker image ls -a

      - name: Run E2E tests
        run: make test-e2e-fork12-multi-pessimistic
        working-directory: test
        env:
          KURTOSIS_FOLDER: ${{ github.workspace }}/kurtosis-cdk
          BATS_LIB_PATH: /usr/lib/
          AGGLAYER_PROVER_SP1_KEY: ${{ secrets.SP1_PRIVATE_KEY }}

      - name: Dump enclave logs
        if: failure()
        run: kurtosis dump ./dump

      - name: Generate archive name
        if: failure()
        run: |
          archive_name="dump_run_with_args_fork12-multi-pessimistic_${{ github.run_id }}"
          echo "ARCHIVE_NAME=${archive_name}" >> "$GITHUB_ENV"
          echo "Generated archive name: ${archive_name}"

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARCHIVE_NAME }}
          path: ./dump
